{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tomar Pedido</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between mb-4">
            <a href="{% url 'registrar_compra' %}" class="btn btn-secondary">Compras</a>
            <p><strong>ID Temporal del Pedido:</strong> {{ id_temporal }}</p>
            <a href="{% url 'signout' %}" class="btn btn-danger">Salir</a>
        </div>

        <h1 class="text-center mb-4">Tomar Pedido</h1>

        <!-- Formulario principal -->
        <form id="pedido-form" method="POST" action="{% url 'savePedido' %}">
            {% csrf_token %}

            <!-- Lista de productos -->
            <div class="row">
                {% for item in productos_context %}
                <div class="col-md-4 mb-4 producto-card">
                    <div class="card h-100">
                        {% if item.producto.imgProducto %}
                        <img src="{{ item.producto.imgProducto.url }}" class="card-img-top" alt="{{ item.producto.nombre }}">
                        {% else %}
                        <img src="/static/img/default.jpg" class="card-img-top" alt="Imagen no disponible">
                        {% endif %}

                        <div class="card-body">
                            <h5 class="card-title">{{ item.producto.nombre }}</h5>
                            <p class="card-text">Precio: ${{ item.producto.precio|floatformat:2 }}</p>

                            <!-- Botón para abrir modal -->
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-{{ item.producto.idProducto }}">
                                Personalizar
                            </button>

                            <!-- Cantidad -->
                            <div class="mt-3">
                                <label for="cantidad-{{ item.producto.idProducto }}" class="form-label">Cantidad:</label>
                                <input 
                                    type="number" 
                                    class="form-control cantidad-input" 
                                    id="cantidad-{{ item.producto.idProducto }}" 
                                    name="cantidad_{{ item.producto.idProducto }}" 
                                    value="0" min="0" 
                                    data-precio="{{ item.producto.precio }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para personalizar producto -->
                <div class="modal fade" id="modal-{{ item.producto.idProducto }}" tabindex="-1" aria-labelledby="modalLabel-{{ item.producto.idProducto }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalLabel-{{ item.producto.idProducto }}">Ingredientes para {{ item.producto.nombre }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Selecciona ingredientes adicionales:</h6>
                                {% if item.ingredientes_adicionales %}
                                    {% for vinculo in item.ingredientes_adicionales %}
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="checkbox" 
                                            value="{{ vinculo.ingrediente.id }}" 
                                            id="ingrediente-{{ vinculo.ingrediente.id }}-{{ item.producto.idProducto }}" 
                                            name="ingredientes_{{ item.producto.idProducto }}[]">
                                        <label 
                                            class="form-check-label" 
                                            for="ingrediente-{{ vinculo.ingrediente.id }}-{{ item.producto.idProducto }}">
                                            {{ vinculo.ingrediente.nombre }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p>No hay ingredientes adicionales disponibles para este producto.</p>
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-success" onclick="agregarAlPedido('{{ item.producto.idProducto }}')">
                                    Añadir al Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="text-center mt-4">
                <p><strong>Total del Pedido: $<span id="total-pedido">0.00</span></strong></p>
                <button type="submit" class="btn btn-success">Guardar Pedido</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cantidadInputs = document.querySelectorAll('.cantidad-input');
            const totalPedidoElement = document.getElementById('total-pedido');

            function calcularTotal() {
                let total = 0;
                cantidadInputs.forEach(input => {
                    const cantidad = parseFloat(input.value) || 0;
                    const precio = parseFloat(input.dataset.precio);
                    total += cantidad * precio;
                });
                totalPedidoElement.textContent = total.toFixed(2);
            }

            cantidadInputs.forEach(input => {
                input.addEventListener('input', calcularTotal);
            });
        });
    </script>
</body>
</html>
